awsRegion: us-east-1

rbac:
  create: true

fluentdConfig : |-
  <match fluent.**>
    @type null
  </match>

  <source>
    @type tail
    @id in_tail_container_logs
    path /var/log/containers/*.log
    pos_file /var/log/fluentd-containers.log.pos
    tag kubernetes.*
    read_from_head true
    <parse>
      @type json
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </parse>
  </source>

  <filter kubernetes.**>
    @type kubernetes_metadata
  </filter>

  <filter kubernetes.**>
    @type record_transformer
    @id filter_rt_kube_logs
    enable_ruby true
    <record>
      service ${record["kubernetes"]["container_name"]}
      pod ${record["kubernetes"]["pod_name"]}
    </record>
  </filter>

  <filter kubernetes.**>
    @type parser
    key_name log
    reserve_data true
    remove_key_name_field true
    emit_invalid_record_to_error false
    <parse>
      @type json
    </parse>
  </filter>

  <match **pgc-system**>
    @type cloudwatch_logs
    log_group_name "kubernetes.pgc-system"
    log_stream_name_key service
    remove_log_group_name_key true
    remove_log_stream_name_key true
    auto_create_stream true
  </match>

  <match **nodeservers**>
    @type cloudwatch_logs
    log_group_name "kubernetes.nodeservers"
    log_stream_name_key service
    remove_log_group_name_key true
    remove_log_stream_name_key true
    auto_create_stream true
  </match>

  <match **nodeservers**>
    @type s3
    s3_bucket s3://kube-nodeserver-logs
    s3_region us-east-1
    <instance_profile_credentials>
      ip_address 169.254.169.254
      port 80
    </instance_profile_credentials>
    path /logs/${service}/
    s3_object_key_format %{path}/%{tag}.%{file_extension}
    <buffer service>
      @type file
      chunk_limit_size 10MB
      flush_at_shutdown true
      flush_interval 30s
      flush_thread_count 10
      path /var/log/fluent/s3
    </buffer>
  </match>

  <match *>
    @type cloudwatch_logs
    log_group_name "kubernetes.system"
    log_stream_name_key service
    remove_log_group_name_key true
    remove_log_stream_name_key true
    auto_create_stream true
  </match>